name: Commit Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  commit-lint:
    name: Validate Commit Messages
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional

    - name: Validate commit messages
      run: |
        echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
        npx commitlint --from=origin/main --to=HEAD --verbose

    - name: Check PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert

  size-check:
    name: Check PR Size
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check changed files
      run: |
        CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
        echo "Changed files: $CHANGED_FILES"
        if [ $CHANGED_FILES -gt 20 ]; then
          echo "::warning::This PR changes $CHANGED_FILES files. Consider splitting into smaller PRs."
        fi

    - name: Check lines added/removed
      run: |
        STATS=$(git diff --stat HEAD~1 | tail -1)
        echo "Change stats: $STATS"
        LINES_CHANGED=$(git diff --numstat HEAD~1 | awk '{add+=$1; del+=$2} END {print add+del}')
        echo "Total lines changed: $LINES_CHANGED"
        if [ $LINES_CHANGED -gt 500 ]; then
          echo "::warning::This PR changes $LINES_CHANGED lines. Consider splitting into smaller PRs."
        fi